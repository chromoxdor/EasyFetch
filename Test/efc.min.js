var currentDivId,menu;window.efc=!0,window.configMode=!1;var selectionData={},saveButton=null,resetButton=null,toggleButton=null;let efcArray=[];const pointerEventsStyle=document.createElement("style");function addContext(){document.addEventListener("contextmenu",handleRightClick,!0)}function handleRightClick(e){e.preventDefault();let t,n=e.target.closest('div[id^="efc"]');if(addPointerEvents(),null===n){t=e.target;const o=Array.from(t.children);o.length>0&&o.forEach((o=>{if(o.id.includes("efc")){const o=document.elementFromPoint(e.clientX,e.clientY);o&&(n=o,n.classList.contains("sensors")&&(n=o?.parentElement),t.id.startsWith("sliderList")&&(n=o?.parentElement?.parentElement))}}))}if(n&&n.id.startsWith("efc")){isittime=!1,updateSaveButton(),currentDivId=n.id,removeHighlighting(),highlightMatchingDivs(n.id,n.className),rebuildContextMenu(),e.detail.clientX?(xCoord=e.detail.clientX,yCoord=e.detail.clientY):(xCoord=e.clientX,yCoord=e.clientY),menu.style.display="block";const t=document.getElementById("custom-menu");if(t&&t.offsetWidth>0){const e=t.offsetWidth,n=t.offsetHeight;let o=xCoord;xCoord+e>window.innerWidth&&(o=window.innerWidth-e),t.style.left=`${o}px`;let i=yCoord+5;yCoord+n>window.innerHeight&&(i=window.innerHeight-n-5),t.style.top=`${i}px`}}else(t.id.startsWith("allList")||t.id.startsWith("container"))&&(updateSaveButton("hide"),selectionData={},runonce2=!0)}function highlightMatchingDivs(e,t){let n=e.substring(0,e.lastIndexOf(","));if(!n)return;document.querySelectorAll(`div[id^="${n}"]`).forEach((e=>{e.style.outline="2px solid #ffcc00"}));let o=document.getElementById(e);o&&(t.includes("bigNumWrap")?(o.parentElement.style.setProperty("transition","none","important"),o.parentElement.style.outline="2px solid red"):o.style.outline="2px solid red")}function removeHighlighting(){const e=document.getElementById("allList");e.style.setProperty("transition-property","none");e.querySelectorAll("div").forEach((e=>e.style.outline="")),setTimeout((()=>{e.style.removeProperty("transition")}),50)}function parseDivId(e){if(e.startsWith("efc")){let[t,n]=e.split("="),o=n.match(/(\d+),(\d+),(\d+)(A?)$/);return o?{deviceName:t.split(":")[1],deviceType:parseInt(o[1]),deviceIndex:o[2],valueIndex:"A"===o[4]?"A":o[3]}:null}}function rebuildContextMenu(){let e=parseDivId(currentDivId);if(!e)return;let{deviceName:t,deviceType:n,deviceIndex:o,valueIndex:i}=e;const l=[43,1,81].includes(n);let d=selectionData[o]?selectionData[o][i]:{},a=selectionData[o]?.A?.val;menu.innerHTML="";let s=document.createElement("select");s.id="menu-main-select",s.dataset.key="val";let r="";i.endsWith("A")&&1!==n||"bigVal"===a?(r+='\n            <option value="none">None</option>\n            <option value="bigVal">big values</option>\n        ',i="A",n="A"):r=33===n?'\n            <option value="none">None</option>\n            <option value="dButtons">button</option>\n            <option value="pButtons">push button</option>\n            <option value="vInput">num input</option>\n            <option value="vSlider">slider</option>\n            <option value="nvSlider">no value Slider</option>\n            <option value="tSlider">time slider</option>\n            <option value="thSlider">thermo slider</option>\n            \n        ':'\n            <option value="none">None</option>\n            <option value="vSlider">slider</option>\n        ',s.innerHTML=r,l&&(s.style.display="none"),menu.appendChild(s),menu.appendChild(document.createElement("br")),s.addEventListener("change",(e=>{updateMenuFields(n,e.target.value,t,o),saveSelections(!1)}));let u=s.dataset.key;"bigVal"===a&&(d=selectionData[o]?.A),void 0!==d&&void 0!==d[u]&&(s.value=d[u],l&&(s.value="")),updateMenuFields(n,s.value,t,o,i,l)}function updateMenuFields(e,t,n,o,i,l){let d=document.getElementById("dynamic-fields");d&&menu.removeChild(d),d=document.createElement("div"),d.id="dynamic-fields",d.style.display="grid","A"===e&&["dButtons","pButtons"].includes(t)&&addCheckbox(d," no input","noI"),["vSlider","nvSlider","thSlider"].includes(t)&&addTextInput(d,"range: ","range",t),["dButtons","vSlider"].includes(t)&&33===e&&addCheckbox(d," no input","noI"),["thSlider","tSlider","dButtons","pButtons","bigVal"].includes(t)||"A"===e||1===e||addTextInput(d,"unit: ","unit"),["dButtons"].includes(t)&&33===e&&addTextInput(d,"sendTo: ","sendTo"),"A"!==e||l||addColorPicker(d,"color: ","color"),("A"===e&&!["bigVal"].includes(t)||l||33===e&&!["none","vSlider","nvSlider","thSlider","tSlider","bigVal"].includes(t))&&addNumberInput(d,"order: ","order"),("none"!==t||hasNonEmptyValues(selectionData,o))&&addResetButton(d,o,n),addCheckbox(d," hide ","hide"),menu.appendChild(d);let a=parseDivId(currentDivId);if(a){let{deviceIndex:t,valueIndex:n}=a;"A"===e&&(n="A");let o=selectionData[t]?selectionData[t][n]:{};d.querySelectorAll("input, select").forEach((e=>{let t=e.dataset.key;void 0!==o&&void 0!==o[t]&&("checkbox"===e.type?e.checked=1===o[t]:("number"===e.type||e.tagName.toLowerCase(),e.value=o[t]))}))}d.addEventListener("input",(()=>saveSelections(!1)))}function addTextInput(e,t,n,o){let i=document.createElement("label");i.innerText=t;let l=document.createElement("input");l.type="text","unit"===n&&(l.maxLength=6,l.style.width="6ch"),"range"===n&&(["vSlider","nvSlider"].includes(o)?l.placeholder="0,1024,1":["thSlider"].includes(o)&&(l.placeholder="5,35,1"),l.addEventListener("input",(e=>{l.value=l.value.replace(/[^0-9.,]/g,"")})),l.addEventListener("blur",(()=>{if(""===l.value.trim())return;/^-?\d+(\.\d+)?,-?\d+(\.\d+)?,-?\d+(\.\d+)?$/.test(l.value)||(alert("Invalid format! Please enter three values separated by two commas (e.g., 0,1024,0.5)"),l.value="")}))),"sendTo"===n&&(l.placeholder="nodeNR(,GPIO)",l.style.width="15ch",l.addEventListener("input",(()=>{l.value=l.value.replace(/[^0-9,]/g,"")})),l.addEventListener("blur",(()=>{if(""===l.value.trim())return;/^\d+$|^\d+,?\d+$/.test(l.value)||(alert("Invalid format! Please enter either a nodenumber (e.g., 12) or a nodenumber + comma + the GPIO to toggle (e.g., 2,12)."),l.value="")}))),l.dataset.key=n,e.appendChild(i),e.appendChild(l)}function addNumberInput(e,t,n){let o=document.createElement("label");o.innerText=t;let i=document.createElement("input");i.type="number",i.dataset.key=n,"order"===n&&(i.min="0",i.max="255",i.step="1",i.value="0",i.style.width="4ch"),e.appendChild(o),e.appendChild(i)}function addCheckbox(e,t,n){let o=document.createElement("label"),i=document.createElement("input");i.type="checkbox",i.dataset.key=n,o.appendChild(i),o.appendChild(document.createTextNode(t)),e.appendChild(o)}function addColorPicker(e,t,n){let o=document.createElement("label");o.innerText=t;let i=document.createElement("input");i.type="color",i.dataset.key=n,e.appendChild(o),e.appendChild(i)}function addResetButton(e,t,n){let o=document.createElement("button");e.appendChild(document.createElement("br")),o.innerText=`reset ${n}`,o.style.backgroundColor="#7d1414",o.style.color="white",o.style.padding="2px",o.addEventListener("click",(()=>deleteDevice(t))),e.appendChild(o)}function hasNonEmptyValues(e,t){return!(!e[t]||"object"!=typeof e[t])&&Object.values(e[t]).some((e=>Object.values(e).some((e=>0!==e&&""!==e&&void 0!==e))))}function deleteDevice(e){delete selectionData[e],saveSelections(!0),menu.style.display="none",removeHighlighting(),isittime=!0}function saveSelections(e){let t=parseDivId(currentDivId);if(!t)return;let{deviceIndex:n,valueIndex:o}=t;selectionData[n]||(selectionData[n]={}),selectionData[n][o]||(selectionData[n][o]={});let i=document.getElementById("dynamic-fields"),l={};selectionData.unit=unit,selectionData.nr=unitNr;let d=document.getElementById("menu-main-select");if(d){let e=d.dataset.key;e&&(l[e]=d.value)}i&&i.querySelectorAll("input, select").forEach((e=>{let t=e.dataset.key;"checkbox"===e.type?l[t]=e.checked?1:0:"number"===e.type?l[t]=parseFloat(e.value)||0:"text"===e.type?l[t]=e.value:"color"===t&&"#000000"===e.value?l[t]="":l[t]=e.value})),"bigVal"===selectionData[n]?.A?.val&&(o="A"),e||(selectionData[n][o]=l),removeEmptyKeys(selectionData),updateSaveButton()}function keepOnlyA(e){if(e&&"object"==typeof e)for(const t in e)"A"!==t&&delete e[t]}function updateSaveButton(e){"hide"!==e?(saveButton.style.display="block",resetButton.style.display="block",hasHiddenProperty(selectionData)&&(toggleButton.style.display="block"),window.configMode=!0):(saveButton.style.display="none",resetButton.style.display="none",toggleButton.style.display="none",window.configMode=!1)}function createSaveButton(){(saveButton=document.createElement("button")).innerText="Save Settings",saveButton.style.position="fixed",saveButton.style.top="10px",saveButton.style.left="calc(50% - 40px)",saveButton.style.transform="translateX(-120px)",saveButton.style.padding="10px 15px",saveButton.style.background="#28a745",saveButton.style.color="white",saveButton.style.border="none",saveButton.style.borderRadius="5px",saveButton.style.cursor="pointer",saveButton.style.zIndex="3",saveButton.style.display="none",saveButton.addEventListener("click",saveToFile),document.body.appendChild(saveButton),(resetButton=document.createElement("button")).innerText="Reset File",resetButton.style.position="fixed",resetButton.style.top="10px",resetButton.style.left="calc(50% + 30px)",resetButton.style.transform="translateX(-50%)",resetButton.style.padding="10px 15px",resetButton.style.background="red",resetButton.style.color="white",resetButton.style.border="none",resetButton.style.borderRadius="5px",resetButton.style.cursor="pointer",resetButton.style.zIndex="3",resetButton.style.display="none",resetButton.addEventListener("click",(()=>saveToFile("del"))),document.body.appendChild(resetButton),(toggleButton=document.createElement("button")).innerText=hiddenOverride?"Hide":"Show",toggleButton.style.position="fixed",toggleButton.style.top="10px",toggleButton.style.left="calc(50% + 128px)",toggleButton.style.transform="translateX(-50%)",toggleButton.style.padding="10px 15px",toggleButton.style.background="#007bff",toggleButton.style.color="white",toggleButton.style.border="none",toggleButton.style.borderRadius="5px",toggleButton.style.cursor="pointer",toggleButton.style.zIndex="3",toggleButton.style.display="none",document.body.appendChild(toggleButton),toggleButton.addEventListener("click",(()=>{hiddenOverride=!hiddenOverride,toggleButton.innerText=hiddenOverride?"Hide":"Show"}))}function saveToFile(e){"use strict";updateJsonArray(selectionData);let t=JSON.stringify(selectionData,null,2);"del"===e&&(t="{}",selectionData.unit&&(efcArray=efcArray.filter((e=>e.unit!==selectionData.unit))));let n=JSON.stringify(efcArray,null,2);loadScript("https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js",(function(){const e=pako.gzip(t),o=new File([e],"efc.json.gz",{type:"application/gzip"}),i=new FormData;i.append("file",o);const l=`${baseUrl}/upload`;if(unitNr!==unitNr1&&fetchFile(l,i),isMain){const e=pako.gzip(n),t=new File([e],"main_efc.json.gz",{type:"application/gzip"}),o=new FormData;o.append("file",t),fetchFile("/upload",o)}})),updateSaveButton("hide"),runonce2=!0}function fetchFile(e,t){const n=new AbortController,o=setTimeout((()=>n.abort()),2e3);fetch(e,{method:"POST",body:t,mode:"cors",signal:n.signal}).then((e=>{if(clearTimeout(o),!e.ok)throw new Error(`HTTP error! Status: ${e.status}`)})).catch((e=>{clearTimeout(o)}))}function createMenu(){document.addEventListener("touchstart",(function(e){2==e.touches.length&&("none"===saveButton.style.display?(updateSaveButton(),setLongPressDelay(200),document.addEventListener("long-press",handleRightClick,!0)):(updateSaveButton("hide"),selectionData={},runonce2=!0,setLongPressDelay(600),document.removeEventListener("long-press",handleRightClick,!0)))}),!0),document.addEventListener("click",(e=>{menu.contains(e.target)||e.target.className.includes("vInputs")||(menu.style.display="none",removeHighlighting(),removePointerEvents(),isittime=!0)})),(menu=document.createElement("div")).id="custom-menu",menu.style.position="absolute",menu.style.display="none",menu.style.background="#3a3a3ad9",menu.style.border="1px solid #ccc",menu.style.padding="10px",menu.style.color="white",document.body.appendChild(menu),createSaveButton(),updateSaveButton("hide")}function jsonpRequest(e,t){let n=document.createElement("script");n.src=`${e}?callback=${t}`,document.body.appendChild(n)}function handleData(e){document.body.innerHTML+=`<p>Received data: ${JSON.stringify(e)}</p>`}function updateJsonArray(e){let t=efcArray.findIndex((t=>t.unit===e.unit));-1!==t?efcArray[t]={...efcArray[t],...e}:efcArray.push(e)}function removeEmptyKeys(e){for(let t in e)e.hasOwnProperty(t)&&("object"==typeof e[t]&&null!==e[t]?removeEmptyKeys(e[t]):""!==e[t]&&null!==e[t]&&void 0!==e[t]||delete e[t])}function loadScript(e,t){const n=document.createElement("script");n.src=e,n.type="text/javascript",n.onload=t,document.head.appendChild(n)}function addPointerEvents(){pointerEventsStyle.innerHTML="#container * { pointer-events: all !important; }",document.head.appendChild(pointerEventsStyle)}function removePointerEvents(){pointerEventsStyle&&pointerEventsStyle.remove()}function hasHiddenProperty(e){for(const t of Object.values(e))if("object"==typeof t&&null!==t&&(1===t.hide||hasHiddenProperty(t)))return!0;return!1}